name: 2 bootstrap toolchain

on:
  workflow_dispatch:

env:
  CONFIG_PREFIX: 2
  EMERGE_PARAMETERS: --deep --emptytree sys-devel/binutils sys-devel/gcc sys-kernel/linux-headers sys-libs/glibc

jobs:
  emerge:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get --quiet update
          sudo apt-get --quiet install rclone

      - name: Set up Gentoo environment
        run: |
          # Download, extract, and clean up the Gentoo tarball
          sudo rclone --sftp-host ${{ secrets.RCLONE_SFTP_HOST }} --sftp-pass ${{ secrets.RCLONE_SFTP_PASS }} --sftp-user ${{ secrets.RCLONE_SFTP_USER }} copy :sftp:$CONFIG_PREFIX.tar.xz /mnt
          sudo mkdir /mnt/gentoo
          sudo tar --directory=/mnt/gentoo --extract --file=/mnt/$CONFIG_PREFIX.tar.xz --numeric-owner --preserve-permissions --xattrs-include='*.*'
          sudo rm /mnt/$CONFIG_PREFIX.tar.xz

      - name: Mount filesystems
        run: |
          sudo mount --types proc /proc /mnt/gentoo/proc
          sudo mount --rbind /sys /mnt/gentoo/sys
          sudo mount --make-rslave /mnt/gentoo/sys
          sudo mount --rbind /dev /mnt/gentoo/dev
          sudo mount --make-rslave /mnt/gentoo/dev
          sudo mount --bind /run /mnt/gentoo/run
          sudo mount --make-slave /mnt/gentoo/run

          # Copy the locale configuration file
          sudo cp ./$CONFIG_PREFIX/locale.gen /mnt/gentoo/etc

          # Copy the Portage configuration files
          sudo cp --recursive ./$CONFIG_PREFIX/portage /mnt/gentoo/etc
          sudo cp ./$CONFIG_PREFIX/make-emerge.conf /mnt/gentoo/etc/portage/make.conf

          # Remove the default Gentoo binary package host configuration
          sudo rm /mnt/gentoo/etc/portage/binrepos.conf/gentoobinhost.conf

          # Copy the host's DNS configuration into the chroot
          sudo cp  /etc/resolv.conf /mnt/gentoo/etc

      - name: Chroot and run emerge-first.sh
        run: |
          sudo cp ./$CONFIG_PREFIX/emerge-first.sh /mnt/gentoo/tmp
          sudo chroot /mnt/gentoo /usr/bin/bash /tmp/emerge-first.sh "$EMERGE_PARAMETERS"
          sudo rm --recursive /mnt/gentoo/tmp/*

      - name: Unmount filesystems
        if: always()
        run: |
          sudo umount --lazy /mnt/gentoo/{dev,proc,run,sys}

      - name : Upload Gentoo tarball
        if: always()
        run: |
          # Create a tarball of the Gentoo environment
          sudo rm --recursive /mnt/gentoo/var/cache/distfiles/*
          sudo rm --recursive /mnt/gentoo/var/db/repos/gentoo
          sudo tar --create --directory=/mnt/gentoo --file=/mnt/$CONFIG_PREFIX.tar.xz --numeric-owner --preserve-permissions --xattrs-include='*.*' --xz .
          sudo rclone --sftp-host ${{ secrets.RCLONE_SFTP_HOST }} --sftp-pass ${{ secrets.RCLONE_SFTP_PASS }} --sftp-user ${{ secrets.RCLONE_SFTP_USER }} copy /mnt/$CONFIG_PREFIX.tar.xz :sftp:$CONFIG_PREFIX.tar.xz
