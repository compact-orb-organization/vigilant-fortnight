name: 2 bootstrap toolchain resume

on:
  workflow_dispatch:

env:
  CONFIG_PREFIX: 2
  EMERGE_PARAMETERS: --resume

jobs:
  emerge:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get --quiet update
          sudo apt-get --quiet install rclone

      - name: Set up Gentoo environment
        run: |
          # Download, extract, and clean up the Gentoo tarball
          rclone --sftp-host ${{ secrets.RCLONE_SFTP_HOST }} --sftp-pass ${{ secrets.RCLONE_SFTP_PASS }} --sftp-user ${{ secrets.RCLONE_SFTP_USER }} copy :sftp:$CONFIG_PREFIX.tar.xz /tmp
          sudo mkdir /var/lib/gentoo
          sudo tar --directory=/var/lib/gentoo --extract --file=/tmp/$CONFIG_PREFIX.tar.xz --numeric-owner --preserve-permissions --xattrs-include='*.*'
          rm /tmp/$CONFIG_PREFIX.tar.xz

      - name: Mount filesystems
        run: |
          sudo mount --types proc /proc /var/lib/gentoo/proc
          sudo mount --rbind /sys /var/lib/gentoo/sys
          sudo mount --make-rslave /var/lib/gentoo/sys
          sudo mount --rbind /dev /var/lib/gentoo/dev
          sudo mount --make-rslave /var/lib/gentoo/dev
          sudo mount --bind /run /var/lib/gentoo/run
          sudo mount --make-slave /var/lib/gentoo/run
          sudo mount --types tmpfs tmpfs /var/lib/gentoo/tmp

      - name: Chroot and run emerge.sh
        run: |
          sudo cp ./$CONFIG_PREFIX/emerge.sh /var/lib/gentoo/tmp
          sudo chroot /var/lib/gentoo /usr/bin/bash /tmp/emerge.sh "$EMERGE_PARAMETERS"
          sudo rm /var/lib/gentoo/tmp/emerge.sh

      - name: Unmount filesystems
        if: always()
        run: |
          sudo umount --lazy /var/lib/gentoo/dev{/shm,/pts}
          sudo umount --lazy /var/lib/gentoo/tmp
          sudo umount /var/lib/gentoo/{dev,proc,run,sys}

      - name : Upload Gentoo tarball
        if: always()
        run: |
          # Create a tarball of the Gentoo environment
          rm --recursive /var/lib/gentoo/var/db/repos/gentoo
          tar --create --directory=/var/lib/gentoo --file=/var/tmp/$CONFIG_PREFIX.tar.xz --numeric-owner --preserve-permissions --xattrs-include='*.*' --xz .
          rclone --sftp-host ${{ secrets.RCLONE_SFTP_HOST }} --sftp-pass ${{ secrets.RCLONE_SFTP_PASS }} --sftp-user ${{ secrets.RCLONE_SFTP_USER }} copy /var/tmp/$CONFIG_PREFIX.tar.xz :sftp:$CONFIG_PREFIX.tar.xz
